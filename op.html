<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Soviet Style Card Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Oswald', sans-serif;
  background: #b22222; /* Soviet Red */
  color: #fff;
  text-align: center;
  margin: 0;
  padding: 20px;
}

h1 {
  margin-bottom: 15px;
  letter-spacing: 2px;
  text-transform: uppercase;
}

form {
  margin-bottom: 20px;
  background: #fff8dc; /* Soviet yellow-cream */
  padding: 15px;
  border-radius: 4px;
  display: inline-block;
  text-align: left;
  border: 3px solid #a52a2a; /* Brownish-red */
  color: #000;
}

label {
  display: block;
  margin: 8px 0;
  font-weight: bold;
  text-transform: uppercase;
}

input, textarea {
  width: 250px;
  padding: 6px;
  border: 2px solid #a52a2a;
  background: #fff;
  font-family: 'Oswald', sans-serif;
  font-size: 14px;
}

button {
  margin-top: 10px;
  padding: 8px 15px;
  border: none;
  background: #a52a2a;
  color: white;
  font-weight: bold;
  letter-spacing: 1px;
  cursor: pointer;
}

button:hover {
  background: #8b1a1a;
}

.container {
  display: flex;
  gap: 20px;
  justify-content: center;
  flex-wrap: wrap;
}

.card {
  position: relative;
  width: 627px;
  height: 382px;
  background: #fff8dc;
  background-size: cover;
  background-position: center;
  border: 4px solid #a52a2a;
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

.card .field {
  position: absolute;
  font-size: 16px;
  font-weight: bold;
  color: #000;
  text-transform: uppercase;
}

.front {
  background-image: url('card_front.png');
}

.back {
  background-image: url('card_back.png');
}

/* FRONT FIELD POSITIONS */
#f_mno { top: 165px; left: 170px; }
#f_name { top: 200px; left: 170px; }
#f_age { top: 230px; left: 170px; }
#f_occ { top: 270px; left: 190px; }

/* BACK FIELD POSITIONS */
#b_address {
  top: 43px;
  left: 185px;
  width: 356px;
  white-space: pre-wrap;
  line-height: 1.8em;
  word-break: break-word;
}
#b_branch { top: 128px; left: 155px; }
#b_blood { top: 170px; left: 240px; }
#b_validity { top: 250px; left: 100px; }
#b_hname { top: 15px; left: 250px; }

/* PHOTO POSITION */
#profilePhoto {
  position: absolute;
  top: 181px;
  left: 471px;
  width: 80px;
  height: 90px;
  object-fit: cover;
}
</style>
</head>
<body>

<h1> <b>KSCWCU</b> CARD Generator</h1>

<form id="cardForm">
  <label>Name: <input type="text" id="name"></label>
  <label>Age: <input type="number" id="age"></label>
  <label>Occupation: <input type="text" id="occ"></label>
  <label>husband/father: <input type="text" id="hname"></label>
  <label>Address: <textarea rows="3" id="address"></textarea></label>
  <label>Branch: <input type="text" id="branch"></label>
  <label>Blood Group: <input type="text" id="blood"></label>
  <label>Upload Photo: <input type="file" id="photoUpload" accept="image/*"></label>
  <label>validity:<input type='text' id="validity"></label>
  <button type="button" onclick="generateCard()">Generate Card</button>
  <input type="reset" value="NEW">
</form>

<div class="container" id="cardWrapper">
  <div class="card front" id="card_front">
    <div class="field" id="f_mno"></div>
    <div class="field" id="f_name"></div>
    <div class="field" id="f_age"></div>
    <div class="field" id="f_occ"></div>
    <img id="profilePhoto" />
  </div>

  <div class="card back" id="card_back">
    <div class="field" id="b_hname"></div>
    <div class="field" id="b_address"></div>
    <div class="field" id="b_branch"></div>
    <div class="field" id="b_blood"></div>
    <div class="field" id="b_validity"></div>
  </div>
</div>

<br>
<button onclick="printCard()">Print Card</button>
<button onclick="printCard2()">Print Back</button>
<h2>Saved Cards</h2>
<div id="savedCards"></div>
<button onclick="resetDatabase()">Reset Database</button>
<!-- Export / Import Buttons -->
<button onclick="exportDatabase()">Export Database</button>
<button onclick="exportToExcel()">Export to Excel</button>
<input type="file" id="importFile" style="display:none" accept=".json" onchange="importDatabase(event)">
<button onclick="document.getElementById('importFile').click()">Import Database</button>

<script>
function exportDatabase() {
  const db = localStorage.getItem('cardsDB');
  const cardNum = localStorage.getItem('lastCardNumber');
  
  const exportData = {
    lastCardNumber: cardNum,
    cardsDB: JSON.parse(db || '[]')
  };

  const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = "card_database_backup.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importDatabase(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.cardsDB && Array.isArray(data.cardsDB)) {
        localStorage.setItem('cardsDB', JSON.stringify(data.cardsDB));
        localStorage.setItem('lastCardNumber', data.lastCardNumber || 0);
        alert("Database imported successfully!");
        renderSavedCards();
      } else {
        alert("Invalid database file!");
      }
    } catch (err) {
      alert("Error reading file!");
    }
  };
  reader.readAsText(file);
}
</script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
let cardNumber = 100;
let editIndex = null; // null means new card

// Load last number
if (localStorage.getItem('lastCardNumber')) {
  cardNumber = parseInt(localStorage.getItem('lastCardNumber'), 10);
}

window.onload = function() {
  renderSavedCards();
};

document.getElementById('photoUpload').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('profilePhoto').src = e.target.result;
    }
    reader.readAsDataURL(file);
  }
});

function generateCard() {
  let db = JSON.parse(localStorage.getItem('cardsDB')) || [];

  if (editIndex === null) {
    // New card → increment number
    cardNumber++;
    localStorage.setItem('lastCardNumber', cardNumber);
  } else {
    // Editing → keep the old number
    cardNumber = db[editIndex].cardNumber;
  }

  const cardData = {
    cardNumber,
    name: document.getElementById('name').value,
    age: document.getElementById('age').value,
    occ: document.getElementById('occ').value,
    address: document.getElementById('address').value,
    branch: document.getElementById('branch').value,
    blood: document.getElementById('blood').value,
    photo: document.getElementById('profilePhoto').src,
    validity: document.getElementById('validity').value,
    hname: document.getElementById('hname').value
  };

  if (editIndex === null) {
    db.push(cardData);
  } else {
    db[editIndex] = cardData; // replace old record
    editIndex = null; // reset edit mode
  }

  localStorage.setItem('cardsDB', JSON.stringify(db));

  // Update preview
  document.getElementById('f_mno').textContent = "kscwcu" + cardData.cardNumber;
  document.getElementById('f_name').textContent = cardData.name;
  document.getElementById('f_age').textContent = cardData.age;
  document.getElementById('f_occ').textContent = cardData.occ;
  document.getElementById('b_address').textContent = cardData.address;
  document.getElementById('b_branch').textContent = cardData.branch;
  document.getElementById('b_blood').textContent = cardData.blood;
  document.getElementById('b_validity').textContent = cardData.validity;
  document.getElementById('b_hname').textContent = cardData.hname;
  

  renderSavedCards();
}

function renderSavedCards() {
  const db = JSON.parse(localStorage.getItem('cardsDB')) || [];
  const listContainer = document.getElementById('savedCards');
  listContainer.innerHTML = "";

  db.forEach((card, index) => {
    const cardDiv = document.createElement('div');
    cardDiv.style.border = "1px solid #fff";
    cardDiv.style.padding = "10px";
    cardDiv.style.margin = "5px";
    cardDiv.style.background = "#8b0000";

    cardDiv.innerHTML = `
      <strong>KSCWCU ${card.cardNumber}</strong> - ${card.name}, ${card.age}<br>
      ${card.occ} | ${card.branch} | ${card.blood}<br>
      ${card.address}<br>
      <img src="${card.photo}" width="50" height="60" style="border:1px solid #fff;"><br>
      <button onclick="editCard(${index})">Edit</button>
      <button onclick="deleteCard(${index})">Delete</button>
    `;
    listContainer.appendChild(cardDiv);
  });
}

function editCard(index) {
  const db = JSON.parse(localStorage.getItem('cardsDB'));
  const card = db[index];

  document.getElementById('name').value = card.name;
  document.getElementById('age').value = card.age;
  document.getElementById('occ').value = card.occ;
  document.getElementById('address').value = card.address;
  document.getElementById('branch').value = card.branch;
  document.getElementById('blood').value = card.blood;
  document.getElementById('validity').src = card.photo;
  document.getElementById('hname').value = card.hname;

  editIndex = index; // now we know we’re editing
}

function deleteCard(index) {
  let db = JSON.parse(localStorage.getItem('cardsDB'));
  db.splice(index, 1);
  localStorage.setItem('cardsDB', JSON.stringify(db));
  renderSavedCards();
}

function resetDatabase() {
  if (confirm("Are you sure you want to reset all stored cards and numbers?")) {
    localStorage.removeItem('lastCardNumber');
    localStorage.removeItem('cardsDB');
    cardNumber = 1000;
    location.reload();
  }
}
function printCard() {
  const cardElement = document.getElementById("card_front");
  html2canvas(cardElement, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
   const printWindow = window.open("", "_blank");
  printWindow.document.write('<img src="' + imgData + '" style="width:100%;">');
  printWindow.document.close();
  printWindow.onload = () => printWindow.print(); // ensures image is rendered
// fallback: small timeout if onload isn't fired on some browsers
  setTimeout(() => printWindow.print(), 500);

  });
}

function printCard2() {
  const cardElement = document.getElementById("card_back");
  html2canvas(cardElement, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
  const printWindow = window.open("", "_blank");
  printWindow.document.write('<img src="' + imgData + '" style="width:100%;">');
  printWindow.document.close();
  printWindow.onload = () => printWindow.print(); // ensures image is rendered
// fallback: small timeout if onload isn't fired on some browsers
  setTimeout(() => printWindow.print(), 500);

  });
}
function exportToExcel() {
  const db = JSON.parse(localStorage.getItem('cardsDB') || '[]');
  
  if (db.length === 0) {
    alert("No data to export!");
    return;
  }

  // Convert objects to array of arrays for Excel
  const sheetData = [
    ["Card Number", "Name", "Age", "Occupation", "Address", "Branch", "Blood Group","validity","husband/father"]
  ];

  db.forEach(card => {
    sheetData.push([
      "kscwcu" + card.cardNumber,
      card.name,
      card.age,
      card.occ,
      card.hname,
      card.address,
      card.branch,
      card.blood,
      card.validity
    ]);
  });

  // Create worksheet and workbook
  const ws = XLSX.utils.aoa_to_sheet(sheetData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Cards");

  // Export to file
  XLSX.writeFile(wb, "card_database.xlsx");
}

</script>

</body>
</html>
